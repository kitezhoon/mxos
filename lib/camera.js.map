{"version":3,"sources":["lib/camera.ts"],"names":[],"mappings":"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","file":"camera.js","sourcesContent":["///<reference path=\"../rpos.d.ts\"/>\nimport { Utils }  from './utils';\nimport fs = require('fs');\nimport parser = require('body-parser');\nimport { ChildProcess } from 'child_process';\nimport { v4l2ctl } from './v4l2ctl';\n\nvar utils = Utils.utils;\n\nclass Camera {\n  options = {\n    resolutions: <Resolution[]>[\n      { Width: 640, Height: 480 },\n      { Width: 800, Height: 600 },\n      { Width: 1024, Height: 768 },\n      { Width: 1280, Height: 1024 },\n      { Width: 1280, Height: 720 },\n      { Width: 1640, Height: 1232 },\n      { Width: 1920, Height: 1080 }\n    ],\n    framerates: [2, 5, 10, 15, 25, 30],\n    bitrates: [\n      250,\n      500,\n      1000,\n      2500,\n      5000,\n      7500,\n      10000,\n      12500,\n      15000,\n      17500\n    ]\n  }\n\n  settings: CameraSettingsBase = {\n    forceGop: true,\n    resolution: <Resolution>{ Width: 1280, Height: 720 },\n    framerate: 25,\n  }\n  \n  config: rposConfig;\n  rtspServer: ChildProcess;\n  webserver: any;\n\n  constructor(config: rposConfig, webserver: any) {\n    this.config = config;\n    this.rtspServer = null;\n    if (this.config.RTSPServer != 0) {\n      if (this.config.CameraType == 'usbcam') {\n        if (this.config.RTSPServer != 3) {\n          // Only GStreamer RTSP is supported now\n          console.log('Only GStreamer RTSP is supported now');\n          process.exit(1);\n        }\n        if (!fs.existsSync(this.config.CameraDevice)) {\n          // USB cam is not found\n          console.log(`USB Camera is not found at ${this.config.CameraDevice}`);\n          process.exit(1);\n        }\n      } else { // == 'picam' as default\n        if (!fs.existsSync(\"/dev/video0\")) {\n          // this.loadDriver();\n          if (utils.isPi()) {\n            // Needs a V4L2 Driver to be installed\n            console.log('Use modprobe to load the Pi Camera V4L2 driver');\n            console.log('e.g.   sudo modprobe bcm2835-v4l2');\n            console.log('       or the uv4l driver');\n            process.exit(1);\n          }\n        }\n      }\n    }\n    this.webserver = webserver;\n\n    this.setupWebserver();\n    this.setupCamera();\n\n    v4l2ctl.ReadControls();\n\n    utils.cleanup(() => {\n      this.stopRtsp();\n      var stop = new Date().getTime() + 2000;\n      while (new Date().getTime() < stop) {\n        //wait for rtsp server to stop\n        ;\n      }\n//      this.unloadDriver();\n    });\n\n    if (this.config.RTSPServer == 1 )fs.chmodSync(\"./bin/rtspServer\", \"0755\");\n  }\n\n  setupWebserver() {\n    utils.log.info(\"Starting camera settings webserver on http://%s:%s/\", utils.getIpAddress(), this.config.ServicePort);\n    this.webserver.use(parser.urlencoded({ extended: true }));\n    this.webserver.engine('ntl', (filePath, options, callback) => {\n      this.getSettingsPage(filePath, callback);\n    });\n    this.webserver.set('views', './views'); // specify the views directory\n    this.webserver.set('view engine', 'ntl'); // register the template engine\n    this.webserver.get('/', (req, res) => {\n      res.render('camera', {});\n    });\n    this.webserver.post('/', (req, res) => {\n      for (var par in req.body) {\n        var g = par.split('.')[0];\n        var p = par.split('.')[1];\n        if (p && g) {\n          var prop = <v4l2ctl.UserControl<any>>v4l2ctl.Controls[g][p];\n          var val = req.body[par];\n          if (val instanceof Array)\n            val = (<any[]>val).pop();\n          prop.value = val;\n          if (prop.isDirty) {\n            utils.log.debug(\"Property %s changed to %s\", par, prop.value);\n          }\n        }\n      }\n      v4l2ctl.ApplyControls();\n      res.render('camera', {});\n    });\n  }\n\n  getSettingsPage(filePath, callback) {\n    v4l2ctl.ReadControls();\n    fs.readFile(filePath, (err, content) => {\n      if (err)\n        return callback(new Error(err.message));\n\n      var parseControls = (html: string, displayname: string, propname: string, controls: Object) => {\n        html += `<tr><td colspan=\"2\"><strong>${displayname}</strong></td></tr>`;\n        for (var uc in controls) {\n          var p = <v4l2ctl.UserControl<any>>controls[uc];\n          if (p.hasSet) {\n            var set = p.getLookupSet();\n            html += `<tr><td><span class=\"label\">${uc}</span></td><td><select name=\"${propname}.${uc}\">`;\n            for (let o of set) {\n              html += `<option value=\"${o.value}\" ${o.value == p.value ? 'selected=\"selected\"' : ''}>${o.desc}</option>`;\n            }\n            html += '</select></td></tr>';\n\n          } else if (p.type == \"Boolean\") {\n            html += `<tr><td><span class=\"label\">${uc}</span></td>\n              <td><input type=\"hidden\" name=\"${propname}.${uc}\" value=\"false\" />\n              <input type=\"checkbox\" name=\"${propname}.${uc}\" value=\"true\" ${p.value ? 'checked=\"checked\"' : ''}/></td><tr>`;\n          } else {\n            html += `<tr><td><span class=\"label\">${uc}</span></td>\n              <td><input type=\"text\" name=\"${propname}.${uc}\" value=\"${p.value}\" />`\n            if (p.hasRange)\n              html += `<span>( min: ${p.getRange().min} max: ${p.getRange().max} )</span>`\n            html += `</td><tr>`;\n          }\n        }\n        return html;\n      }\n\n      var html = parseControls(\"\", 'User Controls', 'UserControls', v4l2ctl.Controls.UserControls);\n      html = parseControls(html, 'Codec Controls', 'CodecControls', v4l2ctl.Controls.CodecControls);\n      html = parseControls(html, 'Camera Controls', 'CameraControls', v4l2ctl.Controls.CameraControls);\n      html = parseControls(html, 'JPG Compression Controls', 'JPEGCompressionControls', v4l2ctl.Controls.JPEGCompressionControls);\n\n      var rendered = content.toString().replace('{{row}}', html);\n      return callback(null, rendered);\n    })\n  }\n\n  loadDriver() {\n      try {\n          utils.execSync(\"sudo modprobe bcm2835-v4l2\"); // only on PI, and not needed with USB Camera\n      } catch (err) {}\n  }\n  \n  unloadDriver(){\n      try {\n          utils.execSync(\"sudo modprobe -r bcm2835-v4l2\");\n      } catch (err) {}\n  }\n\n  setupCamera() {\n    v4l2ctl.SetPixelFormat(v4l2ctl.Pixelformat.H264)\n    v4l2ctl.SetResolution(this.settings.resolution);\n    v4l2ctl.SetFrameRate(this.settings.framerate);\n    v4l2ctl.SetPriority(v4l2ctl.ProcessPriority.record);\n    v4l2ctl.ReadFromFile();\n    v4l2ctl.ApplyControls();\n  }\n\n  setSettings(newsettings: CameraSettingsParameter) {\n    v4l2ctl.SetResolution(newsettings.resolution);\n    v4l2ctl.SetFrameRate(newsettings.framerate);\n\n    v4l2ctl.Controls.CodecControls.video_bitrate.value = newsettings.bitrate * 1000;\n    v4l2ctl.Controls.CodecControls.video_bitrate_mode.value = newsettings.quality > 0 ? 0 : 1;\n    v4l2ctl.Controls.CodecControls.h264_i_frame_period.value = this.settings.forceGop ? v4l2ctl.Controls.CodecControls.h264_i_frame_period.value : newsettings.gop;\n    v4l2ctl.ApplyControls();\n  }\n\n  startRtsp() {\n    if (this.rtspServer) {\n      utils.log.warn(\"Cannot start rtspServer, already running\");\n      return;\n    }\n    utils.log.info(\"Starting Live555 rtsp server\");\n\n    if (this.config.MulticastEnabled) {\n        this.rtspServer = utils.spawn(\"v4l2rtspserver\", [\"-P\", this.config.RTSPPort.toString(), \"-u\" , this.config.RTSPName.toString(), \"-m\", this.config.RTSPMulticastName, \"-M\", this.config.MulticastAddress.toString() + \":\" + this.config.MulticastPort.toString(), \"-W\",this.settings.resolution.Width.toString(), \"-H\", this.settings.resolution.Height.toString(), \"/dev/video0\"]);\n    } else {\n        if (this.config.RTSPServer == 1) this.rtspServer = utils.spawn(\"./bin/rtspServer\", [\"/dev/video0\", \"2088960\", this.config.RTSPPort.toString(), \"0\", this.config.RTSPName.toString()]);\n        if (this.config.RTSPServer == 2) this.rtspServer = utils.spawn(\"v4l2rtspserver\", [\"-P\",this.config.RTSPPort.toString(), \"-u\" , this.config.RTSPName.toString(),\"-W\",this.settings.resolution.Width.toString(),\"-H\",this.settings.resolution.Height.toString(),\"/dev/video0\"]);\n        if (this.config.RTSPServer == 3) this.rtspServer = utils.spawn(\"./python/gst-rtsp-launch.sh\", [\"-P\",this.config.RTSPPort.toString(), \"-u\" , this.config.RTSPName.toString(),\"-W\",this.settings.resolution.Width.toString(),\"-H\",this.settings.resolution.Height.toString(),\"-d\",((this.config.CameraType == 'picam')?('picam'):(this.config.CameraDevice))]);\n    }\n\n    if (this.rtspServer) {\n      this.rtspServer.stdout.on('data', data => utils.log.debug(\"rtspServer: %s\", data));\n      this.rtspServer.stderr.on('data', data => utils.log.error(\"rtspServer: %s\", data));\n      this.rtspServer.on('error', err=> utils.log.error(\"rtspServer error: %s\", err));\n      this.rtspServer.on('exit', (code, signal) => {\n        if (code)\n          utils.log.error(\"rtspServer exited with code: %s\", code);\n        else\n          utils.log.debug(\"rtspServer exited\")\n      });\n    }\n  }\n\n  stopRtsp() {\n    if (this.rtspServer) {\n      utils.log.info(\"Stopping Live555 rtsp server\");\n      this.rtspServer.kill();\n      this.rtspServer = null;\n    }\n  }\n}\n\nexport = Camera;\n"]}